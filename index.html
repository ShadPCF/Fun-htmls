<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>Knock Knock</title>

  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&family=Caveat:wght@700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg0:#06040a;
      --bg1:#12081e;
      --bg2:#2b0f3f;

      --pink:#ff3d8e;
      --gold:#ffd06b;

      --text:rgba(255,255,255,.95);
      --muted:rgba(255,255,255,.72);
      --stroke:rgba(255,255,255,.12);

      --shadow: 0 34px 140px rgba(0,0,0,.72);
      --radius: 40px;
      --radiusIn: 28px;

      --safeT: env(safe-area-inset-top, 0px);
      --safeB: env(safe-area-inset-bottom, 0px);
      --safeL: env(safe-area-inset-left, 0px);
      --safeR: env(safe-area-inset-right, 0px);

      --easeOut: cubic-bezier(.2,.9,.2,1);
      --easeInOut: cubic-bezier(.4,0,.2,1);

      --ui: "Plus Jakarta Sans", ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial;
      --hand: "Caveat", cursive;
    }

    *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
    html,body{ height:100%; }

    body{
      margin:0;
      padding: calc(14px + var(--safeT)) calc(14px + var(--safeR)) calc(16px + var(--safeB)) calc(14px + var(--safeL));
      min-height:100vh;
      min-height:100svh;
      min-height:100dvh;
      display:flex;
      align-items:center;
      justify-content:center;
      font-family: var(--ui);
      color:var(--text);
      overflow:hidden;
      background:
        radial-gradient(1200px 800px at 10% 10%, rgba(255,61,142,.22), transparent 60%),
        radial-gradient(900px 620px at 90% 20%, rgba(255,208,107,.14), transparent 62%),
        linear-gradient(160deg, var(--bg0), var(--bg1) 40%, var(--bg2));
      transform: translate3d(0,0,0);
    }

    .bloom{
      position:fixed;
      width: 380px;
      height: 380px;
      border-radius: 999px;
      filter: blur(30px) saturate(1.06);
      opacity: .18;
      z-index:-3;
      pointer-events:none;
      background:
        radial-gradient(55% 55% at 35% 35%, rgba(255,61,142,.68), transparent 60%),
        radial-gradient(55% 55% at 65% 55%, rgba(255,208,107,.58), transparent 62%),
        radial-gradient(55% 55% at 55% 70%, rgba(255,255,255,.10), transparent 62%);
      animation: bloomDrift 18s var(--easeInOut) infinite;
    }
    .bloom.b1{ left:-140px; top:-140px; }
    .bloom.b2{ right:-150px; bottom:-150px; animation-duration: 22s; opacity:.14; }
    @keyframes bloomDrift{
      0%{ transform: translate3d(-2%, -1%, 0) scale(1.02); }
      50%{ transform: translate3d(2%, 1%, 0) scale(1.06); }
      100%{ transform: translate3d(-2%, -1%, 0) scale(1.02); }
    }

    .ornament{
      position:fixed;
      width: 260px;
      height: 260px;
      z-index:-2;
      opacity:.22;
      pointer-events:none;
      filter: drop-shadow(0 18px 30px rgba(0,0,0,.25));
    }
    .ornament:before{
      content:"";
      position:absolute;
      inset:0;
      border-radius: 0 0 0 170px;
      border-top: 1px solid rgba(255,255,255,.16);
      border-left: 1px solid rgba(255,255,255,.10);
    }
    .ornament:after{
      content:"";
      position:absolute;
      left: 46px;
      top: 46px;
      width: 11px;
      height: 11px;
      border-radius: 999px;
      background: linear-gradient(135deg, rgba(255,61,142,.95), rgba(255,208,107,.92));
      box-shadow: 0 14px 26px rgba(255,61,142,.16);
    }
    .ornTL{ left: 14px; top: 14px; transform: rotate(0deg); }
    .ornBR{ right: 14px; bottom: 14px; transform: rotate(180deg); opacity:.18; }

    .aurora{
      position:fixed;
      inset:-20%;
      z-index:-4;
      filter: blur(26px) saturate(1.1);
      opacity:.78;
      background:
        radial-gradient(600px 420px at 20% 30%, rgba(255,61,142,.28), transparent 60%),
        radial-gradient(520px 420px at 75% 35%, rgba(255,208,107,.16), transparent 62%),
        radial-gradient(520px 460px at 55% 75%, rgba(255,255,255,.05), transparent 62%);
      animation: drift 14s var(--easeInOut) infinite;
      transform: translate3d(0,0,0);
    }
    @keyframes drift{
      0%{ transform: translate3d(-1.5%, -1.2%, 0) scale(1.02) rotate(-1deg); }
      50%{ transform: translate3d(1.3%, 1.0%, 0) scale(1.05) rotate(1deg); }
      100%{ transform: translate3d(-1.5%, -1.2%, 0) scale(1.02) rotate(-1deg); }
    }

    .stars{
      position:fixed;
      inset:0;
      z-index:-3;
      background-image:
        radial-gradient(2px 2px at 12% 22%, rgba(255,255,255,.22) 50%, transparent 52%),
        radial-gradient(1.5px 1.5px at 65% 18%, rgba(255,255,255,.16) 50%, transparent 52%),
        radial-gradient(1.8px 1.8px at 82% 44%, rgba(255,255,255,.12) 50%, transparent 52%),
        radial-gradient(1.2px 1.2px at 22% 76%, rgba(255,255,255,.12) 50%, transparent 52%),
        radial-gradient(1.6px 1.6px at 48% 64%, rgba(255,255,255,.10) 50%, transparent 52%);
      opacity:.58;
      animation: twinkle 7s linear infinite;
    }
    @keyframes twinkle{
      0%,100%{ opacity:.48; filter: blur(0px); }
      50%{ opacity:.72; filter: blur(.2px); }
    }

    .floaters{
      position:fixed;
      inset:0;
      pointer-events:none;
      z-index:2;
      overflow:hidden;
    }
    .floater{
      position:absolute;
      left: var(--x);
      top: 110%;
      font-size: var(--s);
      opacity: 0;
      transform: translate3d(0,0,0);
      filter: drop-shadow(0 14px 18px rgba(0,0,0,.28));
      animation: floatUp var(--d) linear infinite;
      will-change: transform, opacity;
    }
    @keyframes floatUp{
      0%{ opacity: 0; transform: translate3d(0,0,0) rotate(0deg); }
      10%{ opacity: .76; }
      100%{ opacity: 0; transform: translate3d(var(--dx), -145vh, 0) rotate(var(--r)); }
    }

    canvas#confetti{
      position:fixed;
      inset:0;
      pointer-events:none;
      z-index:3;
    }

    .wrap{ width: min(600px, 94vw); }

    .card{
      border-radius: var(--radius);
      border: 1px solid rgba(255,255,255,.10);
      background:
        radial-gradient(900px 380px at 20% -10%, rgba(255,61,142,.12), transparent 60%),
        radial-gradient(900px 380px at 90% 0%, rgba(255,208,107,.08), transparent 62%),
        linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.045));
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
      transform: translate3d(0,0,0);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      outline: 1px solid rgba(255,255,255,.035);
    }
    .card:before{
      content:"";
      position:absolute;
      inset:0;
      pointer-events:none;
      background:
        radial-gradient(1px 1px at 10% 20%, rgba(255,255,255,.08) 50%, transparent 52%),
        radial-gradient(1px 1px at 70% 40%, rgba(255,255,255,.06) 50%, transparent 52%),
        radial-gradient(1px 1px at 30% 80%, rgba(255,255,255,.06) 50%, transparent 52%),
        linear-gradient(180deg, rgba(255,255,255,.05), transparent 40%, rgba(0,0,0,.12));
      opacity:.30;
      mix-blend-mode: overlay;
    }
    .card:after{
      content:"";
      position:absolute;
      inset: 10px;
      border-radius: calc(var(--radius) - 12px);
      pointer-events:none;
      box-shadow:
        inset 0 1px 0 rgba(255,255,255,.10),
        inset 0 0 0 1px rgba(255,255,255,.035);
      opacity:.92;
    }

    /* subtle in-card corner sparkles */
    .cardSparks{
      position:absolute;
      inset:0;
      pointer-events:none;
      z-index:0;
      opacity:.32;
    }
    .spark{
      position:absolute;
      font-size: 14px;
      filter: drop-shadow(0 12px 18px rgba(0,0,0,.22));
      opacity:.0;
      animation: sparkDrift 6.8s var(--easeInOut) infinite;
      transform: translate3d(0,0,0);
    }
    .spark.s1{ left: 18px; top: 18px; animation-delay: .2s; }
    .spark.s2{ right: 20px; top: 26px; animation-delay: 1.1s; font-size: 12px; }
    .spark.s3{ left: 26px; bottom: 22px; animation-delay: 2.0s; font-size: 12px; }
    .spark.s4{ right: 18px; bottom: 18px; animation-delay: 3.2s; }
    @keyframes sparkDrift{
      0%{ opacity: 0; transform: translate3d(0,8px,0) scale(.96) rotate(-6deg); }
      15%{ opacity: .7; }
      55%{ opacity: .25; transform: translate3d(0,-6px,0) scale(1.02) rotate(6deg); }
      100%{ opacity: 0; transform: translate3d(0,8px,0) scale(.96) rotate(-6deg); }
    }

    .top{
      padding: 18px 18px 10px 18px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      position:relative;
      z-index:1;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      min-width:0;
    }

    /* real icon badge */
    .badgeBtn{
      width:40px; height:40px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.12);
      background:
        radial-gradient(120% 120% at 20% 10%, rgba(255,61,142,.28), transparent 55%),
        radial-gradient(120% 120% at 80% 70%, rgba(255,208,107,.20), transparent 60%),
        rgba(0,0,0,.16);
      box-shadow: 0 16px 34px rgba(0,0,0,.24);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:0;
      cursor:pointer;
      flex:0 0 auto;
    }
    .badgeBtn:active{ transform: translate3d(0,1px,0) scale(.99); }
    .badgeBtn svg{
      width:20px;
      height:20px;
      opacity:.92;
      filter: drop-shadow(0 12px 16px rgba(0,0,0,.18));
    }

    h1{
      margin:0;
      font-size:17px;
      font-weight:800;
      letter-spacing:-.25px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .subtitle{
      font-size:12px;
      color:rgba(255,255,255,.70);
      font-weight:600;
      margin-top:2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .meta{
      display:flex;
      align-items:center;
      gap:10px;
      flex:0 0 auto;
    }

    .iconBtn{
      width:38px;
      height:38px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.16);
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.05);
    }
    .iconBtn:active{ transform: translate3d(0,1px,0) scale(.99); }
    .iconBtn svg{ width:18px; height:18px; opacity:.88; }

    /* heart fill progress */
    .heartProg{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 0;
    }
    .heartIcon{
      width:14px;
      height:14px;
      transform: rotate(45deg);
      --hf: linear-gradient(135deg, rgba(255,61,142,.95), rgba(255,208,107,.92));
      background: var(--hf);
      border-radius: 3px;
      filter: drop-shadow(0 10px 18px rgba(255,61,142,.14));
      opacity:.95;
      position:relative;
      flex:0 0 auto;
    }
    .heartIcon:before,
    .heartIcon:after{
      content:"";
      position:absolute;
      width:14px;
      height:14px;
      border-radius:999px;
      background: var(--hf);
    }
    .heartIcon:before{ left:-7px; top:0; }
    .heartIcon:after{ left:0; top:-7px; }

    .heartBar{
      width: 120px;
      height: 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.16);
      overflow:hidden;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.05);
    }
    .heartFill{
      height:100%;
      width: 0%;
      border-radius: 999px;
      background: linear-gradient(135deg, rgba(255,61,142,.95), rgba(255,208,107,.92));
      box-shadow: 0 14px 30px rgba(255,61,142,.14);
      transform: translate3d(0,0,0);
      transition: width 420ms var(--easeInOut);
    }
    .heartTxt{
      font-size:12px;
      font-weight:700;
      color: rgba(255,255,255,.70);
      letter-spacing: -.1px;
      flex:0 0 auto;
    }

    .stage{ padding: 12px 16px 10px 16px; position:relative; z-index:1; }

    .scene{
      border-radius: var(--radiusIn);
      overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
      background:
        radial-gradient(120% 120% at 20% 0%, rgba(255,61,142,.08), transparent 55%),
        radial-gradient(120% 120% at 90% 20%, rgba(255,208,107,.06), transparent 60%),
        rgba(0,0,0,.42);
      box-shadow: 0 20px 80px rgba(0,0,0,.34);
      position:relative;
      transform: translate3d(0,0,0);
    }

    .doorArea{
      position:relative;
      width:100%;
      padding-top: 75%;
      background: transparent;
      overflow:hidden;
    }
    @supports (aspect-ratio: 4 / 3){
      .doorArea{ padding-top:0; aspect-ratio:4 / 3; }
    }

    .doorStage{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      background:
        radial-gradient(80% 70% at 50% 30%, rgba(255,255,255,.10), transparent 60%),
        radial-gradient(120% 100% at 50% 100%, rgba(0,0,0,.56), transparent 55%),
        radial-gradient(140% 120% at 10% 90%, rgba(255,61,142,.12), transparent 60%),
        radial-gradient(120% 120% at 95% 10%, rgba(255,208,107,.10), transparent 62%);
    }

    .persp{
      width: 94%;
      height: 94%;
      perspective: 980px;
      transform: translate3d(0,0,0);
      position:relative;
      cursor:pointer;
    }
    .persp:focus-visible{
      outline: 2px solid rgba(255,208,107,.55);
      outline-offset: 6px;
      border-radius: 26px;
    }

    .doorFrame{
      position:absolute;
      inset:0;
      border-radius: 26px;
      overflow:hidden;
      box-shadow:
        inset 0 0 0 1px rgba(255,255,255,.06),
        0 22px 70px rgba(0,0,0,.25);
      transform: translate3d(0,0,0);
      background: rgba(0,0,0,.10);
    }

    .doorWindow{
      position:absolute;
      inset: 10px;
      border-radius: 22px;
      overflow:hidden;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.08);
      background: rgba(0,0,0,.14);
      transform: translate3d(0,0,0);
    }

    /* subtle vignette to guide focus */
    .doorWindow:before{
      content:"";
      position:absolute;
      inset:0;
      pointer-events:none;
      background:
        radial-gradient(70% 62% at 50% 40%, rgba(255,255,255,.10), transparent 60%),
        radial-gradient(120% 120% at 50% 90%, rgba(0,0,0,.34), transparent 55%),
        linear-gradient(180deg, rgba(0,0,0,.10), transparent 40%, rgba(0,0,0,.20));
      opacity:.95;
      z-index:2;
      mix-blend-mode: normal;
    }

    .doorWindow:after{
      content:"";
      position:absolute;
      inset:0;
      pointer-events:none;
      background:
        radial-gradient(120% 110% at 20% 0%, rgba(255,255,255,.06), transparent 55%),
        radial-gradient(120% 120% at 90% 20%, rgba(255,61,142,.06), transparent 60%),
        radial-gradient(120% 120% at 60% 90%, rgba(255,208,107,.05), transparent 60%);
      opacity:.75;
      mix-blend-mode: screen;
      z-index:3;
    }

    .doorPanel{
      position:absolute;
      inset:0;
      transform-style: preserve-3d;
      transform-origin: 0% 50%;
      transform: rotateY(0deg) translate3d(0,0,0);
      transition: transform 520ms var(--easeOut), filter 520ms ease;
      will-change: transform;
      z-index:1;
    }

    /* clearer door image */
    .doorImg{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit: cover;
      transform: scale(1.03);
      filter: saturate(1.14) contrast(1.08) brightness(1.04);
      user-select:none;
      -webkit-user-drag:none;
      backface-visibility:hidden;
      -webkit-backface-visibility:hidden;
    }

    .edgeGlow{
      position:absolute;
      inset:0;
      pointer-events:none;
      background:
        linear-gradient(90deg, rgba(255,61,142,.14), transparent 22%),
        radial-gradient(90% 120% at 5% 50%, rgba(255,208,107,.14), transparent 55%);
      mix-blend-mode: screen;
      opacity:.48;
      transform: translate3d(0,0,2px);
      z-index:4;
    }

    /* softer fog */
    .fog{
      position:absolute;
      inset:-20%;
      background:
        radial-gradient(600px 380px at 25% 40%, rgba(255,61,142,.08), transparent 62%),
        radial-gradient(520px 420px at 80% 55%, rgba(255,208,107,.07), transparent 62%);
      filter: blur(18px);
      opacity:.42;
      animation: fog 9s ease-in-out infinite;
      pointer-events:none;
      transform: translate3d(0,0,0);
      z-index:2;
    }
    @keyframes fog{
      0%{ transform: translate3d(-2%, -1%, 0) scale(1.02); }
      50%{ transform: translate3d(2%, 1%, 0) scale(1.06); }
      100%{ transform: translate3d(-2%, -1%, 0) scale(1.02); }
    }

    /* loader for door image */
    .imgLoad{
      position:absolute;
      inset:0;
      z-index:6;
      display:flex;
      align-items:center;
      justify-content:center;
      color: rgba(255,255,255,.78);
      font-weight:700;
      font-size:12px;
      letter-spacing:-.1px;
      background:
        linear-gradient(90deg, rgba(255,255,255,.06), rgba(255,255,255,.10), rgba(255,255,255,.06));
      background-size: 200% 100%;
      animation: shimmer 1.35s linear infinite;
      user-select:none;
      pointer-events:none;
    }
    @keyframes shimmer{
      0%{ background-position: 0% 0%; opacity:.55; }
      100%{ background-position: 200% 0%; opacity:.55; }
    }
    .imgLoad.off{ display:none; }

    /* knock smaller and slightly higher */
    .knockImg{
      position:absolute;
      left:50%;
      top:43%;
      width: min(235px, 60%);
      transform-origin: 50% 55%;
      transform: translate3d(-50%,-50%,6px) rotate(-6deg);
      filter: drop-shadow(0 18px 26px rgba(0,0,0,.44));
      animation: knockWiggle 1.05s ease-in-out infinite;
      pointer-events:none;
      user-select:none;
      -webkit-user-drag:none;
      background: transparent;
      will-change: transform;
      opacity:.96;
      z-index:7;
    }
    @keyframes knockWiggle{
      0%{ transform: translate3d(-50%,-50%,6px) rotate(-6deg) scale(1); }
      25%{ transform: translate3d(-49%,-51%,6px) rotate(2deg) scale(1.01); }
      50%{ transform: translate3d(-51%,-49%,6px) rotate(-2deg) scale(1); }
      75%{ transform: translate3d(-49.5%,-50%,6px) rotate(3deg) scale(1.01); }
      100%{ transform: translate3d(-50%,-50%,6px) rotate(-6deg) scale(1); }
    }

    .hint{
      position:absolute;
      left:14px;
      bottom:14px;
      padding:10px 12px;
      border-radius: 14px;
      font-size:12px;
      font-weight:800;
      color: rgba(255,255,255,.86);
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: 0 18px 60px rgba(0,0,0,.20);
      pointer-events:none;
      z-index:8;
    }

    .ripple{
      position:absolute;
      left:50%;
      top:52%;
      width: 18px;
      height: 18px;
      border-radius: 999px;
      border: 2px solid rgba(255,255,255,.45);
      transform: translate3d(-50%,-50%,10px) scale(.2);
      opacity: 0;
      pointer-events:none;
      z-index:9;
    }
    .ripple.go{ animation: ripple 520ms ease-out forwards; }
    @keyframes ripple{
      0%{ opacity:.85; transform: translate3d(-50%,-50%,10px) scale(.2); }
      100%{ opacity:0; transform: translate3d(-50%,-50%,10px) scale(8); }
    }

    .shake{ animation: shake 460ms var(--easeOut); }
    @keyframes shake{
      0%{ transform: translate3d(0,0,0); }
      20%{ transform: translate3d(-2px, 0, 0); }
      40%{ transform: translate3d(2px, -1px, 0); }
      60%{ transform: translate3d(-1px, 1px, 0); }
      80%{ transform: translate3d(1px, 0, 0); }
      100%{ transform: translate3d(0,0,0); }
    }

    .openPeek .doorPanel{ transform: rotateY(-14deg) translate3d(-1.2%,0,0); filter: brightness(1.02) contrast(1.02); }

    .caption{
      position:absolute;
      left:50%;
      top:56%;
      transform: translate3d(-50%,-50%,12px) rotate(-3deg);
      padding: 12px 18px 10px 18px;
      border-radius: 18px;
      font-family: var(--hand);
      font-weight:700;
      font-size: 30px;
      letter-spacing: .2px;
      color: rgba(20,10,24,.96);
      background: linear-gradient(180deg, rgba(255,255,255,.96), rgba(255,255,255,.90));
      border: 1px solid rgba(0,0,0,.10);
      box-shadow: 0 18px 46px rgba(0,0,0,.26);
      pointer-events:none;
      user-select:none;
      text-align:center;
      min-width: 150px;
      z-index:10;
    }
    .caption:before{
      content:"";
      position:absolute;
      inset:0;
      border-radius: 18px;
      pointer-events:none;
      background: repeating-linear-gradient(135deg, rgba(0,0,0,.03) 0 6px, transparent 6px 12px);
      opacity:.20;
      mix-blend-mode: multiply;
    }
    .caption:after{
      content:"üíó";
      position:absolute;
      right: 10px;
      top: 8px;
      font-size: 14px;
      opacity: .85;
      transform: rotate(6deg);
      filter: drop-shadow(0 10px 16px rgba(0,0,0,.16));
    }
    .captionPop{ animation: captionPop 520ms var(--easeOut) both; }
    @keyframes captionPop{
      0%{ opacity:0; transform: translate3d(-50%,-40%,12px) rotate(-3deg) scale(.92); }
      100%{ opacity:1; transform: translate3d(-50%,-50%,12px) rotate(-3deg) scale(1); }
    }

    .bottom{
      padding: 10px 16px 18px 16px;
      display:flex;
      flex-direction:column;
      gap:10px;
      position:relative;
      z-index:1;
    }

    .btn{
      width:100%;
      padding: 15px 16px;
      border-radius: 18px;
      border:none;
      cursor:pointer;
      color:#160610;
      font-size: 15px;
      font-weight:800;
      letter-spacing:-.1px;
      background: linear-gradient(135deg, var(--pink), var(--gold));
      box-shadow: 0 18px 46px rgba(255,61,142,.16);
      position:relative;
      overflow:hidden;
      transform: translate3d(0,0,0);
    }
    .btn:before{
      content:"";
      position:absolute;
      inset:-40%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.52), transparent);
      transform: rotate(25deg);
      opacity:.52;
      animation: btnShine 1.8s var(--easeInOut) infinite;
    }
    @keyframes btnShine{
      0%{ transform: translateX(-35%) rotate(25deg); }
      50%{ transform: translateX(35%) rotate(25deg); }
      100%{ transform: translateX(-35%) rotate(25deg); }
    }
    .btn:active{ transform: translate3d(0,1px,0) scale(.99); }

    .btnGhost{
      width:100%;
      padding: 13px 16px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.14);
      color: rgba(255,255,255,.92);
      font-weight:800;
      letter-spacing:-.1px;
      cursor:pointer;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.05);
    }
    .btnGhost:active{ transform: translate3d(0,1px,0) scale(.99); }

    .note{
      text-align:center;
      font-size:12px;
      color: var(--muted);
      line-height: 1.45;
      padding: 0 8px;
      font-weight:600;
    }

    .reveal{
      padding: 26px 18px 22px 18px;
      min-height: 360px;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      position:relative;
      overflow:hidden;
      background:
        radial-gradient(300px 220px at 50% 12%, rgba(255,208,107,.20), transparent 62%),
        radial-gradient(420px 260px at 10% 80%, rgba(255,61,142,.14), transparent 60%),
        radial-gradient(420px 260px at 90% 75%, rgba(255,255,255,.06), transparent 60%),
        linear-gradient(180deg, rgba(0,0,0,.14), rgba(0,0,0,.06));
    }

    .gift{
      width: min(440px, 96%);
      border-radius: 28px;
      border: 1px solid rgba(255,255,255,.10);
      background:
        radial-gradient(320px 180px at 50% 0%, rgba(255,208,107,.12), transparent 62%),
        linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      box-shadow: 0 22px 88px rgba(0,0,0,.33);
      padding: 18px 16px 18px 16px;
      position:relative;
      transform: translate3d(0,0,0);
      overflow:hidden;
    }
    .gift:after{
      content:"";
      position:absolute;
      inset:0;
      pointer-events:none;
      background:
        radial-gradient(1px 1px at 15% 25%, rgba(255,255,255,.08) 50%, transparent 52%),
        radial-gradient(1px 1px at 75% 45%, rgba(255,255,255,.06) 50%, transparent 52%),
        radial-gradient(1px 1px at 35% 80%, rgba(255,255,255,.06) 50%, transparent 52%),
        linear-gradient(180deg, rgba(255,255,255,.06), transparent 35%, rgba(0,0,0,.10));
      opacity:.28;
      mix-blend-mode: overlay;
    }

    .emoji{
      font-size: 58px;
      filter: drop-shadow(0 18px 26px rgba(0,0,0,.33));
      animation: pop 900ms var(--easeOut) both;
      position:relative;
      z-index:1;
    }
    @keyframes pop{
      0%{ transform: translate3d(0,16px,0) scale(.85); opacity:0; }
      100%{ transform: translate3d(0,0,0) scale(1); opacity:1; }
    }

    .big{
      margin-top: 10px;
      font-size: 24px;
      font-weight:800;
      letter-spacing:-.3px;
      line-height:1.12;
      position:relative;
      z-index:1;
    }

    .sub{
      margin-top: 10px;
      font-size: 14px;
      color: rgba(255,255,255,.82);
      line-height: 1.5;
      font-weight:600;
      position:relative;
      z-index:1;
    }

    .type{ display:inline-block; position:relative; padding-right: 8px; }
    .caret{
      display:inline-block;
      width: 10px;
      height: 18px;
      margin-left: 4px;
      border-radius: 4px;
      background: rgba(255,255,255,.75);
      vertical-align: -3px;
      animation: blink 900ms step-end infinite;
    }
    @keyframes blink{ 50%{ opacity:0; } }

    .stack{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top: 14px;
      position:relative;
      z-index:1;
    }

    .gifWrap{
      margin-top: 12px;
      border-radius: 26px;
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.12);
      box-shadow: 0 20px 70px rgba(0,0,0,.26);
    }
    .gifInner{
      margin: 10px;
      border-radius: 22px;
      overflow:hidden;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.06);
      background: rgba(0,0,0,.10);
    }
    .gifInner img{
      display:block;
      width:100%;
      height:auto;
    }

    .packetClick{
      width:100%;
      border:none;
      padding:0;
      background:transparent;
      cursor:pointer;
      display:block;
    }

    .fadeIn{ animation: fadeIn 420ms var(--easeInOut) both; }
    @keyframes fadeIn{
      from{ opacity:0; transform: translate3d(0,10px,0) scale(.992); }
      to{ opacity:1; transform: translate3d(0,0,0) scale(1); }
    }

    .toast{
      position:absolute;
      left:50%;
      bottom: 14px;
      transform: translateX(-50%);
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.26);
      color: rgba(255,255,255,.88);
      font-weight:700;
      font-size:12px;
      opacity:0;
      pointer-events:none;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      transition: opacity 220ms var(--easeInOut), transform 220ms var(--easeInOut);
      z-index:50;
    }
    .toast.on{
      opacity:1;
      transform: translateX(-50%) translateY(-2px);
    }

    @media (prefers-reduced-motion: reduce){
      .aurora, .stars, .fog, .knockImg, .floater, .btn:before, .bloom, .spark, .imgLoad { animation:none !important; }
      .doorPanel{ transition:none !important; }
      .fadeIn{ animation:none !important; }
      .heartFill{ transition:none !important; }
    }
  </style>
</head>

<body>
  <div class="aurora"></div>
  <div class="stars"></div>

  <div class="bloom b1"></div>
  <div class="bloom b2"></div>
  <div class="ornament ornTL"></div>
  <div class="ornament ornBR"></div>

  <div class="floaters" id="floaters" aria-hidden="true"></div>
  <canvas id="confetti" aria-hidden="true"></canvas>

  <div class="wrap">
    <div class="card" id="card">
      <div class="cardSparks" aria-hidden="true">
        <span class="spark s1">‚ú¶</span>
        <span class="spark s2">‚úß</span>
        <span class="spark s3">‚ú¶</span>
        <span class="spark s4">‚úß</span>
      </div>

      <div class="top">
        <div class="brand">
          <button class="badgeBtn" id="badgeBtn" aria-label="Home">
            <!-- tiny door icon -->
            <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M7.5 3.8h9A2.5 2.5 0 0 1 19 6.3v13.4a2.5 2.5 0 0 1-2.5 2.5h-9A2.5 2.5 0 0 1 5 19.7V6.3A2.5 2.5 0 0 1 7.5 3.8Z" stroke="rgba(255,255,255,.86)" stroke-width="1.6"/>
              <path d="M14.9 12.1a.9.9 0 1 1-1.8 0 .9.9 0 0 1 1.8 0Z" fill="rgba(255,255,255,.86)"/>
              <path d="M9 6.8h6" stroke="rgba(255,255,255,.40)" stroke-width="1.6" stroke-linecap="round"/>
            </svg>
          </button>

          <div style="min-width:0">
            <h1>Knock knock</h1>
            <div class="subtitle" id="subtitleText">Tap the door</div>
          </div>
        </div>

        <div class="meta">
          <button class="iconBtn" id="audioBtn" aria-label="Enable ambient sound" aria-pressed="false">
            <svg id="audioIcon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M11 5 7.8 7.6H5.8A2 2 0 0 0 3.8 9.6v4.8a2 2 0 0 0 2 2h2L11 19V5Z" stroke="rgba(255,255,255,.86)" stroke-width="1.6" stroke-linejoin="round"/>
              <path d="M14.6 9.4c.9.9.9 4.3 0 5.2" stroke="rgba(255,255,255,.60)" stroke-width="1.6" stroke-linecap="round"/>
              <path d="M16.7 7.3c2 2 2 7.4 0 9.4" stroke="rgba(255,255,255,.40)" stroke-width="1.6" stroke-linecap="round"/>
            </svg>
          </button>

          <div class="heartProg" aria-label="progress">
            <div class="heartIcon" aria-hidden="true"></div>
            <div class="heartBar" aria-hidden="true">
              <div class="heartFill" id="heartFill"></div>
            </div>
            <div class="heartTxt" id="heartTxt">1/8</div>
          </div>
        </div>
      </div>

      <div class="stage" id="stage"></div>
      <div class="bottom" id="bottom"></div>

      <div class="toast" id="toast">Copied</div>
    </div>
  </div>

  <script>
    const stage = document.getElementById("stage")
    const bottom = document.getElementById("bottom")
    const card = document.getElementById("card")

    const subtitleText = document.getElementById("subtitleText")
    const heartFill = document.getElementById("heartFill")
    const heartTxt = document.getElementById("heartTxt")

    const audioBtn = document.getElementById("audioBtn")
    const toast = document.getElementById("toast")
    const badgeBtn = document.getElementById("badgeBtn")

    let step = 1
    let autoKnockTimer = null

    let audioReady = false
    let ctx = null
    let ambientOn = false
    let ambientNodes = null

    let lastResult = null

    const DOOR_SRC = "door.jpeg"
    const KNOCK_SRC = "IMG_0143.png"

    const GIF_HUG = "https://media1.tenor.com/m/zIacwDB2Mr0AAAAd/huhhh.gif"
    const GIF_KISS = "https://media1.tenor.com/m/5H7rmBUfr5AAAAAd/love-you.gif"
    const GIF_PACKET = "https://media1.tenor.com/m/T_DRG_1RTIUAAAAd/cny2020-chinese-new-year.gif"

    const TOTAL_STEPS = 8

    const SUBS = {
      1: "Tap the door",
      2: "Who is it",
      3: "Reveal",
      4: "Test your love",
      5: "Hugs and kisses",
      6: "Lucky moment",
      7: "A note for you",
      8: "Red packets"
    }

    preload([DOOR_SRC, KNOCK_SRC, GIF_HUG, GIF_KISS, GIF_PACKET])
    render()

    badgeBtn.onclick = () => { step = 1; render() }

    audioBtn.onclick = async () => {
      ensureAudio()
      if (!audioReady || !ctx) return

      if (ctx.state === "suspended") {
        try { await ctx.resume() } catch(e){}
      }

      ambientOn = !ambientOn
      audioBtn.setAttribute("aria-pressed", ambientOn ? "true" : "false")
      if (ambientOn) startAmbient()
      else stopAmbient()
    }

    function setHeader(){
      if (subtitleText) subtitleText.textContent = SUBS[step] || "Tap the door"
    }

    function setProgress(){
      const current = step
      if (heartTxt) heartTxt.textContent = `${current}/${TOTAL_STEPS}`
      if (heartFill) heartFill.style.width = `${(current / TOTAL_STEPS) * 100}%`
    }

    function doorScene(includeKnock, captionText){
      const cap = captionText ? `<div class="caption captionPop">${captionText}</div>` : ``
      return `
        <div class="scene fadeIn">
          <div class="doorArea">
            <div class="doorStage">
              <div class="persp" id="persp" role="button" tabindex="0" aria-label="Tap the door to knock">
                <div class="doorFrame">
                  <div class="doorWindow">
                    <div class="imgLoad" id="doorLoad">Loading</div>
                    <div class="fog"></div>
                    <div class="doorPanel" id="doorPanel">
                      <img class="doorImg" id="doorImg" src="${DOOR_SRC}" alt="door" />
                      <div class="edgeGlow"></div>
                    </div>
                  </div>
                </div>

                ${cap}
                ${includeKnock ? `<img class="knockImg" id="knockImg" src="${KNOCK_SRC}" alt="knock knock" />` : ``}
                <div class="ripple" id="ripple"></div>
              </div>

              <div class="hint" id="hint">tap the door</div>
            </div>
          </div>
        </div>
      `
    }

    function revealScene(){
      return `
        <div class="scene reveal fadeIn" id="reveal">
          <div class="gift">
            <div class="emoji">üíê</div>
            <div class="big"><span class="type" id="typeText"></span><span class="caret"></span></div>
            <div class="sub">Sending you love and tons of hugs and kisses<br/>Have an amazing day</div>
          </div>
        </div>
      `
    }

    function testScene(){
      return `
        <div class="scene reveal fadeIn">
          <div class="gift">
            <div class="big">Test your love</div>
            <div class="sub">Pick one</div>
            <div class="stack">
              <button class="btnGhost" id="b1">I love you</button>
              <button class="btnGhost" id="b2">I love you heaps</button>
              <button class="btn" id="b3">I love you the most</button>
            </div>
          </div>
        </div>
      `
    }

    function gifEmbed(url, alt){
      return `
        <div class="gifWrap">
          <div class="gifInner">
            <img src="${url}" alt="${alt}" loading="lazy" decoding="async"
              onerror="this.closest('.gifWrap').innerHTML='<div style=&quot;padding:16px;color:rgba(255,255,255,.82);font-weight:800;text-align:center&quot;>gif failed to load<br><a style=&quot;color:rgba(255,255,255,.92)&quot; href=&quot;${url}&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;>open gif</a></div>'" />
          </div>
        </div>
      `
    }

    function resultScene(kind){
      const title = kind === "hug" ? "Internet hug" : "Virtual kisses"
      const embed = kind === "hug"
        ? gifEmbed(GIF_HUG, "hug")
        : gifEmbed(GIF_KISS, "kiss")

      return `
        <div class="scene reveal fadeIn" id="resultTap">
          <div class="gift">
            <div class="big">${title}</div>
            <div class="sub">Tap for confetti</div>
            ${embed}
          </div>
        </div>
      `
    }

    function packetScene(){
      return `
        <div class="scene reveal fadeIn">
          <div class="gift">
            <div class="big">Lucky</div>
            <div class="sub">Tap the red packet</div>

            <button class="packetClick" id="packet" aria-label="Red packet">
              ${gifEmbed(GIF_PACKET, "red packet")}
            </button>
          </div>
        </div>
      `
    }

    function letterScene(){
      return `
        <div class="scene reveal fadeIn">
          <div class="gift">
            <div class="big" style="font-size:18px">üíå</div>
            <div class="sub" style="text-align:left;margin-top:12px">
              Just a little reminder I love you so, so much. You‚Äôre the kindest soul I‚Äôve ever had in my life, and I‚Äôm counting down until you‚Äôre back in my arms. I miss you like crazy. Have the best time, my love, and come back to me soon<br/><br/>
              Love yours,<br/>
              Shad<br/><br/>
              <b>P S Happy early Chinese New Year</b>
            </div>

            <div class="stack">
              <button class="btn" id="toFinal">Final step</button>
            </div>
          </div>
        </div>
      `
    }

    function finalScene(){
      return `
        <div class="scene reveal fadeIn">
          <div class="gift">
            <div class="emoji">üßß</div>
            <div class="big">Check your account for red packets</div>
            <div class="sub">Happy early Chinese New Year</div>
          </div>
        </div>
      `
    }

    function controlsHTML(opts){
      const backBtn = opts.back ? `<button class="btnGhost" id="backBtn">${opts.backText || "Back"}</button>` : ``
      const primary = opts.primaryText ? `<button class="btn" id="${opts.primaryId || "primaryBtn"}">${opts.primaryText}</button>` : ``
      const note = `<div class="note">${opts.note || ""}</div>`
      return `${primary}${backBtn}${note}`
    }

    function render(){
      setHeader()
      setProgress()
      clearAutoKnock()

      if (step === 1){
        stage.innerHTML = doorScene(true, "")
        bottom.innerHTML = controlsHTML({
          primaryText: "Continue",
          primaryId: "nextBtn",
          note: "Tap the door for extra drama"
        })

        wireDoorInteractions({ autoKnock:true, peek:false })
        attachDoorLoaders()

        const k = document.getElementById("knockImg")
        makeWhiteTransparent(k)
        stabilizeKnock(k)

        document.getElementById("nextBtn").onclick = () => { step = 2; render() }
        return
      }

      if (step === 2){
        stage.innerHTML = doorScene(false, "Valen")
        bottom.innerHTML = controlsHTML({
          primaryText: "Reveal",
          primaryId: "nextBtn",
          note: "Tap the door for a cheeky peek",
          back: true
        })

        wireDoorInteractions({ autoKnock:false, peek:true })
        attachDoorLoaders()

        document.getElementById("nextBtn").onclick = () => { step = 3; render() }
        document.getElementById("backBtn").onclick = () => { step = 1; render() }
        return
      }

      if (step === 3){
        stage.innerHTML = revealScene()
        bottom.innerHTML = controlsHTML({
          primaryText: "Next surprise",
          primaryId: "toTest",
          note: "Tap the bouquet for more confetti",
          back: true
        })

        typewriter(document.getElementById("typeText"), "Happy Valentine‚Äôs Day", 28)
        startConfettiBurst(150)
        spawnFloaters(10)

        document.getElementById("reveal").addEventListener("click", () => {
          startConfettiBurst(110)
          spawnFloaters(8)
        }, { passive:true })

        document.getElementById("toTest").onclick = () => { step = 4; render() }
        document.getElementById("backBtn").onclick = () => { step = 2; render() }
        return
      }

      if (step === 4){
        stage.innerHTML = testScene()
        bottom.innerHTML = controlsHTML({
          primaryText: "",
          note: "You can always go back",
          back: true
        })

        document.getElementById("b1").onclick = () => { lastResult = "hug"; step = 5; render() }
        document.getElementById("b2").onclick = () => { lastResult = "kisses"; step = 5; render() }
        document.getElementById("b3").onclick = () => { step = 6; render() }
        document.getElementById("backBtn").onclick = () => { step = 3; render() }
        return
      }

      if (step === 5){
        stage.innerHTML = resultScene(lastResult || "hug")
        bottom.innerHTML = controlsHTML({
          primaryText: "Back to test",
          primaryId: "backToTest",
          note: "Tap anywhere for confetti",
          back: true
        })

        document.getElementById("resultTap").addEventListener("click", () => {
          startConfettiBurst(75)
          spawnFloaters(6)
        }, { passive:true })

        document.getElementById("backToTest").onclick = () => { step = 4; render() }
        document.getElementById("backBtn").onclick = () => { step = 4; render() }
        return
      }

      if (step === 6){
        stage.innerHTML = packetScene()
        bottom.innerHTML = controlsHTML({
          primaryText: "Back to test",
          primaryId: "backToTest",
          note: "Tap the packet",
          back: true
        })

        document.getElementById("packet").onclick = () => { step = 7; render() }
        document.getElementById("backToTest").onclick = () => { step = 4; render() }
        document.getElementById("backBtn").onclick = () => { step = 4; render() }
        return
      }

      if (step === 7){
        stage.innerHTML = letterScene()
        bottom.innerHTML = controlsHTML({
          primaryText: "Back",
          primaryId: "backToPacket",
          note: "Almost there",
          back: false
        })

        document.getElementById("toFinal").onclick = () => { step = 8; render() }
        document.getElementById("backToPacket").onclick = () => { step = 6; render() }
        return
      }

      stage.innerHTML = finalScene()
      bottom.innerHTML = `
        <button class="btn" id="shareBtn">Share link</button>
        <button class="btnGhost" id="replayBtn">Replay from start</button>
        <button class="btnGhost" id="backToTest">Back to test</button>
        <div class="note">Done ‚úÖ</div>
      `

      startConfettiBurst(150)
      spawnFloaters(12)

      document.getElementById("backToTest").onclick = () => { step = 4; render() }
      document.getElementById("replayBtn").onclick = () => { step = 1; render() }
      document.getElementById("shareBtn").onclick = () => shareLink()
    }

    function attachDoorLoaders(){
      const doorImg = document.getElementById("doorImg")
      const loadEl = document.getElementById("doorLoad")
      if (!doorImg || !loadEl) return

      const off = () => loadEl.classList.add("off")
      const on = () => loadEl.classList.remove("off")

      on()
      if (doorImg.complete && doorImg.naturalWidth) {
        off()
      } else {
        doorImg.addEventListener("load", off, { once:true })
        doorImg.addEventListener("error", off, { once:true })
        setTimeout(() => off(), 1800)
      }
    }

    function wireDoorInteractions(opts){
      const persp = document.getElementById("persp")
      const doorPanel = document.getElementById("doorPanel")
      const ripple = document.getElementById("ripple")
      const hint = document.getElementById("hint")

      if (!persp) return
      if (opts.peek) persp.classList.add("openPeek")

      const doKnock = () => {
        if (hint) hint.style.opacity = "0"

        if (ripple){
          ripple.classList.remove("go")
          void ripple.offsetWidth
          ripple.classList.add("go")
        }

        if (doorPanel){
          doorPanel.classList.remove("shake")
          void doorPanel.offsetWidth
          doorPanel.classList.add("shake")
        }

        bumpCard()
        knockSound()
        spawnFloaters(2)
      }

      persp.addEventListener("click", () => doKnock(), { passive:true })
      persp.addEventListener("keydown", (e) => {
        if (e.key === "Enter" || e.key === " ") {
          e.preventDefault()
          doKnock()
        }
      })

      let raf = 0
      const onMove = (x, y, rect) => {
        const nx = (x - (rect.left + rect.width/2)) / (rect.width/2)
        const ny = (y - (rect.top + rect.height/2)) / (rect.height/2)
        if (!raf){
          raf = requestAnimationFrame(() => {
            raf = 0
            const rotY = clamp(nx, -1, 1) * 3
            const rotX = -clamp(ny, -1, 1) * 2
            persp.style.transform = `translate3d(0,0,0) rotateX(${rotX}deg) rotateY(${rotY}deg)`
          })
        }
      }

      const rect = () => persp.getBoundingClientRect()

      persp.addEventListener("mousemove", (e) => onMove(e.clientX, e.clientY, rect()), { passive:true })
      persp.addEventListener("touchmove", (e) => {
        const t = e.touches && e.touches[0]
        if (!t) return
        onMove(t.clientX, t.clientY, rect())
      }, { passive:true })
      persp.addEventListener("mouseleave", () => { persp.style.transform = "translate3d(0,0,0)" }, { passive:true })
      persp.addEventListener("touchend", () => { persp.style.transform = "translate3d(0,0,0)" }, { passive:true })

      if (opts.autoKnock){
        autoKnockTimer = setInterval(() => doKnock(), 2100)
      }
    }

    function stabilizeKnock(imgEl){
      if (!imgEl) return
      const lock = () => {
        imgEl.style.left = "50%"
        imgEl.style.top = "43%"
      }
      lock()
      window.addEventListener("resize", lock, { passive:true })
      window.addEventListener("orientationchange", lock, { passive:true })
      document.addEventListener("visibilitychange", lock, { passive:true })
      setTimeout(lock, 200)
      setTimeout(lock, 700)
    }

    function bumpCard(){
      card.classList.remove("shake")
      void card.offsetWidth
      card.classList.add("shake")
    }

    function clearAutoKnock(){
      if (autoKnockTimer){
        clearInterval(autoKnockTimer)
        autoKnockTimer = null
      }
    }

    function clamp(v, a, b){ return Math.max(a, Math.min(b, v)) }

    function preload(urls){
      urls.forEach(src => {
        const img = new Image()
        img.src = src
      })
    }

    function makeWhiteTransparent(imgEl){
      if (!imgEl || imgEl.dataset.transparentDone) return
      imgEl.dataset.transparentDone = "1"

      const run = () => {
        try{
          const w = imgEl.naturalWidth
          const h = imgEl.naturalHeight
          if (!w || !h) return

          const c = document.createElement("canvas")
          c.width = w
          c.height = h
          const g = c.getContext("2d", { willReadFrequently:true })
          g.drawImage(imgEl, 0, 0)

          const img = g.getImageData(0, 0, w, h)
          const d = img.data

          for (let i = 0; i < d.length; i += 4){
            const r = d[i]
            const gg = d[i+1]
            const b = d[i+2]
            const a = d[i+3]
            if (a === 0) continue

            const lum = 0.2126*r + 0.7152*gg + 0.0722*b
            const newA = Math.max(0, Math.min(255, Math.round((255 - lum) * 3.0)))
            d[i+3] = newA
          }

          g.putImageData(img, 0, 0)
          imgEl.src = c.toDataURL("image/png")
        }catch(e){}
      }

      if (imgEl.complete) run()
      else imgEl.addEventListener("load", run, { once:true })
    }

    function ensureAudio(){
      if (audioReady) return
      try{
        ctx = new (window.AudioContext || window.webkitAudioContext)()
        audioReady = true
      }catch(e){
        audioReady = false
      }
    }

    function knockSound(){
      ensureAudio()
      if (!audioReady || !ctx) return
      if (ctx.state === "suspended"){
        ctx.resume().catch(() => {})
      }

      const now = ctx.currentTime

      const makeHit = (t, freq, dur, gain) => {
        const o = ctx.createOscillator()
        const g = ctx.createGain()
        const f = ctx.createBiquadFilter()

        o.type = "triangle"
        o.frequency.setValueAtTime(freq, t)

        f.type = "lowpass"
        f.frequency.setValueAtTime(980, t)
        f.Q.setValueAtTime(0.8, t)

        g.gain.setValueAtTime(0.0001, t)
        g.gain.exponentialRampToValueAtTime(gain, t + 0.01)
        g.gain.exponentialRampToValueAtTime(0.0001, t + dur)

        o.connect(f)
        f.connect(g)
        g.connect(ctx.destination)

        o.start(t)
        o.stop(t + dur + 0.02)
      }

      makeHit(now + 0.00, 210, 0.09, 0.10)
      makeHit(now + 0.07, 180, 0.11, 0.08)
    }

    function startAmbient(){
      if (!ctx || ambientNodes) return

      const out = ctx.createGain()
      out.gain.value = 0.0001

      const filt = ctx.createBiquadFilter()
      filt.type = "lowpass"
      filt.frequency.value = 520
      filt.Q.value = 0.6

      const o1 = ctx.createOscillator()
      const o2 = ctx.createOscillator()
      o1.type = "sine"
      o2.type = "sine"
      o1.frequency.value = 110
      o2.frequency.value = 220
      o2.detune.value = 7

      const lfo = ctx.createOscillator()
      const lfoGain = ctx.createGain()
      lfo.type = "sine"
      lfo.frequency.value = 0.10
      lfoGain.gain.value = 0.006

      lfo.connect(lfoGain)
      lfoGain.connect(out.gain)

      o1.connect(filt)
      o2.connect(filt)
      filt.connect(out)
      out.connect(ctx.destination)

      o1.start()
      o2.start()
      lfo.start()

      const now = ctx.currentTime
      out.gain.setValueAtTime(0.0001, now)
      out.gain.exponentialRampToValueAtTime(0.018, now + 0.45)

      ambientNodes = { out, filt, o1, o2, lfo, lfoGain }
    }

    function stopAmbient(){
      if (!ctx || !ambientNodes) return
      const { out, o1, o2, lfo } = ambientNodes
      const now = ctx.currentTime
      try{
        out.gain.cancelScheduledValues(now)
        out.gain.setValueAtTime(Math.max(0.0001, out.gain.value), now)
        out.gain.exponentialRampToValueAtTime(0.0001, now + 0.28)
      }catch(e){}

      setTimeout(() => {
        try{ o1.stop() }catch(e){}
        try{ o2.stop() }catch(e){}
        try{ lfo.stop() }catch(e){}
        try{ out.disconnect() }catch(e){}
        ambientNodes = null
      }, 340)
    }

    function typewriter(el, text, speed){
      if (!el) return
      el.textContent = ""
      let i = 0
      const tick = () => {
        i++
        el.textContent = text.slice(0, i)
        if (i < text.length) setTimeout(tick, speed)
      }
      tick()
    }

    function spawnFloaters(count){
      const box = document.getElementById("floaters")
      if (!box) return

      const icons = ["üíó","üíû","üíñ","üíò","‚ú®","üíù"]
      for (let i = 0; i < count; i++){
        const el = document.createElement("div")
        el.className = "floater"
        el.textContent = icons[(Math.random() * icons.length) | 0]

        const x = (Math.random() * 100).toFixed(2) + "vw"
        const s = (14 + Math.random() * 18).toFixed(0) + "px"
        const d = (7 + Math.random() * 6).toFixed(2) + "s"
        const dx = ((Math.random() * 26) - 13).toFixed(2) + "vw"
        const r = ((Math.random() * 160) - 80).toFixed(0) + "deg"

        el.style.setProperty("--x", x)
        el.style.setProperty("--s", s)
        el.style.setProperty("--d", d)
        el.style.setProperty("--dx", dx)
        el.style.setProperty("--r", r)

        box.appendChild(el)
        setTimeout(() => { try{ el.remove() }catch(e){} }, 14000)
      }
    }

    function showToast(msg){
      if (!toast) return
      toast.textContent = msg || "Copied"
      toast.classList.add("on")
      setTimeout(() => toast.classList.remove("on"), 1100)
    }

    async function shareLink(){
      const url = location.href
      try{
        if (navigator.share) {
          await navigator.share({ title: "Knock knock", url })
          return
        }
      } catch(e){}

      try{
        await navigator.clipboard.writeText(url)
        showToast("Link copied")
      } catch(e){
        showToast("Copy failed")
        try{ prompt("Copy this link", url) }catch(_){}
      }
    }

    const confetti = (() => {
      const canvas = document.getElementById("confetti")
      const c = canvas.getContext("2d")
      let W = 0, H = 0
      let pieces = []
      let running = false

      const resize = () => {
        const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1))
        W = Math.floor(window.innerWidth)
        H = Math.floor(window.innerHeight)
        canvas.width = Math.floor(W * dpr)
        canvas.height = Math.floor(H * dpr)
        canvas.style.width = W + "px"
        canvas.style.height = H + "px"
        c.setTransform(dpr, 0, 0, dpr, 0, 0)
      }

      const add = (n) => {
        const cx = W * 0.5
        const cy = H * 0.35
        for (let i = 0; i < n; i++){
          const t = Math.random() * Math.PI * 2
          const sp = 2 + Math.random() * 6
          pieces.push({
            x: cx + (Math.random() * 18 - 9),
            y: cy + (Math.random() * 18 - 9),
            vx: Math.cos(t) * sp,
            vy: Math.sin(t) * sp - 1.5,
            g: 0.12 + Math.random() * 0.10,
            r: 2 + Math.random() * 4,
            a: 1,
            rot: Math.random() * Math.PI * 2,
            vr: (Math.random() - 0.5) * 0.35,
            kind: Math.random() < 0.55 ? "heart" : "spark"
          })
        }
      }

      const drawHeart = (x, y, s, rot) => {
        c.save()
        c.translate(x, y)
        c.rotate(rot)
        c.scale(s, s)
        c.beginPath()
        c.moveTo(0, 0.35)
        c.bezierCurveTo(-0.5, -0.15, -0.55, -0.55, 0, -0.25)
        c.bezierCurveTo(0.55, -0.55, 0.5, -0.15, 0, 0.35)
        c.closePath()
        c.fill()
        c.restore()
      }

      const tick = () => {
        if (!running) return
        c.clearRect(0, 0, W, H)

        for (let i = pieces.length - 1; i >= 0; i--){
          const p = pieces[i]
          p.vy += p.g
          p.x += p.vx
          p.y += p.vy
          p.rot += p.vr
          p.a *= 0.988

          if (p.y > H + 40 || p.a < 0.03){
            pieces.splice(i, 1)
            continue
          }

          const grad = c.createLinearGradient(p.x - 10, p.y - 10, p.x + 10, p.y + 10)
          grad.addColorStop(0, "rgba(255,61,142," + (0.85 * p.a) + ")")
          grad.addColorStop(1, "rgba(255,208,107," + (0.85 * p.a) + ")")
          c.fillStyle = grad

          if (p.kind === "heart"){
            drawHeart(p.x, p.y, p.r, p.rot)
          } else {
            c.globalAlpha = p.a
            c.beginPath()
            c.arc(p.x, p.y, p.r, 0, Math.PI * 2)
            c.fill()
            c.globalAlpha = 1
          }
        }

        if (pieces.length === 0){
          running = false
          return
        }
        requestAnimationFrame(tick)
      }

      window.addEventListener("resize", resize, { passive:true })
      resize()

      return {
        burst(n){
          add(n)
          if (!running){
            running = true
            requestAnimationFrame(tick)
          }
        }
      }
    })()

    function startConfettiBurst(n){
      confetti.burst(n || 120)
    }

    window.addEventListener("pointerdown", () => { ensureAudio() }, { passive:true, once:true })
  </script>
</body>
</html>
